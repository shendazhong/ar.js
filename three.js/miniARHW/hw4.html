<!DOCTYPE html>
<meta
  name="viewport"
  content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
/>
<script src="../examples/vendor/three.js/build/three.min.js"></script>
<script src="../examples/vendor/three.js/examples/js/libs/stats.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="../build/ar.js"></script>
<script>
  THREEx.ArToolkitContext.baseURL = '../';
</script>
<body style="margin: 0px; overflow: hidden; font-family: Monospace">
  <div
    style="
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      z-index: 1;
    "
  ></div>

  <script>
    var scene, camera, renderer, stats;
    var arToolKitSource, arToolKitContext;
    var markerRoot, markerHiro;
    var _iOSDevice;
    var down = false,
      isActive = false;
    var cannon, clock, ball, pos, vel, force;

    init();
    animate();

    function init() {
      let _iOSDevice = !!navigator.platform.match(/iPhone|iPod|iPad/);

      if (_iOSDevice) $('#is_IOS').text('IOS Device');
      else $('#is_IOS').text('Not IOS Device');

      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });

      renderer.setClearColor(new THREE.Color('lightgrey'), 0);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.domElement.style.position = 'absolute';
      renderer.domElement.style.top = '0px';
      renderer.domElement.style.left = '0px';
      document.body.appendChild(renderer.domElement);

      stats = new Stats();
      document.body.appendChild(stats.dom);

      scene = new THREE.Scene();
      camera = new THREE.Camera();
      scene.add(camera);

      arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam',
      });

      arToolkitSource.init(function onReady() {
        onResize();
      });

      window.addEventListener('resize', function () {
        onResize();
      });

      arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl:
          THREEx.ArToolkitContext.baseURL + '../data/data/camera_para.dat',
        detectionMode: 'mono',
        maxDetectionRate: 30,
        canvasWidth: 80 * 3,
        canvasHeight: 60 * 3,
      });

      arToolkitContext.init(function onCompleted() {
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
      });

      markerHiro = addMarkerHiro();
      scene.add(markerHiro);
    }

    function addMarkerHiro() {
      markerRoot = new THREE.Group();

      var artoolkitMarker = new THREEx.ArMarkerControls(
        arToolkitContext,
        markerRoot,
        {
          type: 'pattern',
          patternUrl:
            THREEx.ArToolkitContext.baseURL + '../data/data/patt.hiro',
        }
      );

      var gridXZ = new THREE.GridHelper(1, 10, 'red', 'white');
      markerRoot.add(gridXZ);

      cannon = makeCannon();
      markerRoot.add(cannon);
      ball = new THREE.Mesh(
        new THREE.SphereGeometry(0.01, 0.04, 0.04),
        new THREE.MeshBasicMaterial({ color: 'yellow', wireframe: true })
      );
      markerRoot.add(ball);

      clock = new THREE.Clock();

      let barrel = cannon.children[1];
      barrel.rotation.z = -Math.PI / 6;
      cannon.rotation.y = -Math.PI / 6;

      return markerRoot;
    }

    function makeCannon() {
      let cannon = new THREE.Group();
      let body = new THREE.Mesh(
        new THREE.SphereGeometry(
          0.05,
          0.1,
          0.1,
          Math.PI + Math.PI * 0.1,
          Math.PI * 1.8,
          0,
          Math.PI / 2
        ),
        new THREE.MeshNormalMaterial()
      );
      let barrelPart = new THREE.Group();
      let barrel = new THREE.Mesh(
        new THREE.CylinderGeometry(0.01, 0.01, 0.1, 0.09),
        new THREE.MeshNormalMaterial()
      );
      barrelPart.add(barrel);
      barrel.position.y = 0.05;

      cannon.add(body, barrelPart);
      return cannon;
    }

    function computeInitPosVel() {
      let barrel = cannon.children[1];
      const SPEED = 0.5;
      vel = barrel
        .localToWorld(new THREE.Vector3(0, 0.1, 0))
        .sub(barrel.localToWorld(new THREE.Vector3(0, 0, 0)))
        .setLength(SPEED);
      pos = barrel.localToWorld(new THREE.Vector3(0, 0.11, 0));
      force = new THREE.Vector3(0, -0.5, 0);
    }

    function animate() {
      requestAnimationFrame(animate);
      stats.update();
      renderer.render(scene, camera);

      if (arToolkitSource.ready === false) return;
      arToolkitContext.update(arToolkitSource.domElement);

      if (pos === undefined) {
        computeInitPosVel();
        return;
      }
      if (pos.y < 0) {
      }

      let dt = clock.getDelta();

      vel.add(force.clone().multiplyScalar(dt));
      pos.add(vel.clone().multiplyScalar(dt));
      ball.position.copy(pos);
    }

    function onResize() {
      arToolkitSource.onResize();
      arToolkitSource.copySizeTo(renderer.domElement);
      if (arToolkitContext.arController !== null) {
        arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
      }
    }
  </script>
</body>
